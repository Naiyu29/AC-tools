<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通用AC斷面分析工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 60vh;
            width: 100%;
        }
        .small-chart-container {
            position: relative;
            height: 40vh; /* Smaller height for overview charts */
            width: 100%;
        }
        .data-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        #shareModal, .collapsible-content {
            transition: all 0.3s ease-in-out;
        }
        .input-title {
            background-color: transparent; border: none; font-size: 1.25rem; font-weight: 600;
            color: #374151; width: 100%; padding: 0.25rem 0.5rem; margin-left: -0.5rem; border-radius: 0.25rem;
        }
        .input-title:focus {
            outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); background-color: #f9fafb;
        }
        .input-title.extra {
            color: #6b7280; /* gray-500 */
        }
        .collapsible-header {
            cursor: pointer;
        }
        .chevron-icon {
            transition: transform 0.3s;
        }
        /* Custom radio button styles */
        .radio-label {
            display: inline-block;
            background-color: #e5e7eb;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            color: #4b5563;
        }
        input[type="radio"]:checked + .radio-label {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">通用AC斷面分析工具</h1>
            <p class="mt-2 text-gray-600">輸入斷面資料，計算高程差、面積與體積，並產生分享連結。</p>
        </header>

        <!-- 操作說明 -->
        <div class="data-card mb-8">
             <div class="collapsible-header flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">核心功能與操作</h3>
                <svg class="chevron-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div class="collapsible-content mt-4 text-gray-600 space-y-3 hidden">
                <ol class="list-decimal list-inside space-y-2">
                    <li><strong>輸入/匯入資料</strong>: 可手動貼上資料至下方三個斷面區塊，或點擊「匯入資料」選擇先前下載的 <code>.json</code> 檔案。</li>
                    <li><strong>分析計算</strong>: 點擊「處理資料並分析」按鈕，程式將自動計算並顯示下方的所有分析報告。</li>
                    <li><strong>選擇分析對象</strong>: 在報告區塊中，您可以選擇要比較哪兩個斷面，相關的面積、體積與高程差分析將會自動更新。</li>
                    <li><strong>查看報告</strong>: 各分析報告區塊的標題列皆可點擊以展開或收合內容，方便聚焦查閱。</li>
                    <li><strong>分享結果</strong>: 點擊「分享結果」按鈕。若資料量不大，會產生分享連結；若資料量過大，則会引導您下載資料檔，確保分享穩定可靠。</li>
                </ol>
            </div>
        </div>

        <!-- 資料輸入區 -->
        <div class="space-y-6">
            <div class="data-card">
                <input type="text" id="section1Name" class="input-title mb-3" value="原地面">
                <textarea id="section1Data" class="w-full h-48 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="格式: 里程 ... 高程... 支距..."></textarea>
            </div>
             <div class="data-card">
                <input type="text" id="section2Name" class="input-title mb-3" value="刨除後">
                <textarea id="section2Data" class="w-full h-48 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" placeholder="格式: 里程 高程... 支距..."></textarea>
            </div>
            <div class="data-card">
                <input type="text" id="section3Name" class="input-title extra mb-3" value="舖築後">
                <textarea id="section3Data" class="w-full h-48 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 transition" placeholder="格式: 里程 高程... 支距... (選填)"></textarea>
            </div>
        </div>

        <div class="flex justify-center items-center space-x-4 my-8">
             <button id="importButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                匯入資料
            </button>
            <button id="processButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                處理資料並分析
            </button>
            <button id="shareButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                分享結果
            </button>
        </div>
        <input type="file" id="fileInput" class="hidden" accept=".json">

        <div id="error-message" class="text-center text-red-500 font-medium my-4"></div>

        <!-- 結果顯示區 -->
        <div id="results-container" class="space-y-8">
            <div id="individual-results" class="data-card hidden">
                <div class="collapsible-header flex justify-between items-center border-b pb-4 mb-6"><h3 class="text-2xl font-bold text-gray-800">斷面分析</h3><svg class="chevron-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                <div class="collapsible-content hidden">
                    <div class="flex items-center space-x-3 mb-6"><label for="mileageSelector" class="text-lg font-medium">選擇里程:</label><select id="mileageSelector" class="p-2 border border-gray-300 rounded-md"></select></div>
                    <div id="analysis-selector-1" class="mb-6"></div>
                    <div class="bg-gray-50 p-4 rounded-lg mb-6 text-center"><h4 id="area-title" class="text-xl font-semibold text-gray-700">斷面面積</h4><div id="areaDisplay" class="text-lg mt-2">--</div></div>
                    <div id="chartContainer" class="chart-container mb-8"><canvas id="elevationChart"></canvas></div>
                    <div><h4 class="text-xl font-semibold mb-4">高程差詳細資料</h4><div id="differenceTableContainer" class="overflow-x-auto"></div></div>
                </div>
            </div>
            <div id="all-mileage-card" class="data-card hidden">
                 <div class="collapsible-header flex justify-between items-center border-b pb-4 mb-6"><h3 class="text-2xl font-bold text-gray-800">全里程斷面</h3><svg class="chevron-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                <div id="allMileageChartsContainer" class="collapsible-content grid grid-cols-1 lg:grid-cols-2 gap-8 hidden"></div>
            </div>
            <div id="summary-results" class="data-card hidden">
                <div class="collapsible-header flex justify-between items-center border-b pb-4 mb-6"><h3 class="text-2xl font-bold text-gray-800">高程差總表</h3><svg class="chevron-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                <div class="collapsible-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-6">
                        <div class="md:col-span-2"><label for="customOffsets" class="block text-sm font-medium text-gray-700 mb-1">指定支距 (以空格分隔):</label><input type="text" id="customOffsets" class="w-full p-2 border border-gray-300 rounded-md" placeholder="-4.2 -2.8 0 2.8 4.2"></div>
                        <div><button id="summaryButton" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg">生成總表</button></div>
                    </div>
                    <div id="summaryTableContainer" class="overflow-x-auto"></div>
                </div>
            </div>
            <div id="volume-summary-card" class="data-card hidden">
                 <div class="collapsible-header flex justify-between items-center border-b pb-4 mb-6"><h3 class="text-2xl font-bold text-gray-800">總土方量與斷面積摘要</h3><svg class="chevron-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                <div class="collapsible-content hidden">
                    <div id="analysis-selector-2" class="mb-6"></div>
                    <div class="bg-gray-50 p-6 rounded-lg mb-6 text-center"><h4 id="volume-title" class="text-xl font-semibold">總土方量</h4><div id="totalVolumeDisplay" class="text-2xl mt-2 font-bold">--</div></div>
                    <div><h4 id="area-table-title" class="text-xl font-semibold mb-4">各斷面積列表</h4><div id="areaTableContainer" class="overflow-x-auto"></div></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="shareModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div id="shareModalContent" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg transform transition-all scale-95">
             <!-- Content is generated dynamically by JS -->
        </div>
    </div>

    <footer class="text-center text-sm text-gray-500 py-8 px-4">
        <p id="footer-timestamp">此程式最後於 2025年7月7日 01:31 完成第24次的修改。</p>
        <p class="mt-1">從最初的斷面繪圖，到後來加入面積、土方量計算，並建構出更穩定的分享機制，這是一段不斷學習與解決問題的過程。</p>
        <p class="mt-1">希望這個持續演進的小工具，能為您的工作帶來一些便利。</p>
    </footer>

    <script>
        let charts = {}, dataMap1 = {}, dataMap2 = {}, dataMap3 = {}, allSortedMileages = [];
        let analysisPair = { a: 1, b: 2 }; // Default comparison
        const URL_LENGTH_LIMIT = 4000;

        function parseData(dataString) {
            const dataMap = {};
            if (!dataString || dataString.trim() === '') return dataMap;

            dataString.trim().split('\n').forEach((line, index) => {
                if (line.trim() === '') return;
                const values = line.split(/\s+/).filter(v => v.trim() !== '' && !isNaN(v)).map(Number);
                if (values.length < 3) return;

                const mileage = values.shift();
                
                let found = false;
                for (let k = Math.floor(values.length / 2); k >= 1; k--) {
                    if (values.length >= k * 2) {
                        const dataBlock = values.slice(values.length - k * 2);
                        const potentialElevations = dataBlock.slice(0, k);
                        const potentialOffsets = dataBlock.slice(k);
                        
                        if (potentialOffsets.includes(0)) {
                            dataMap[mileage] = Array.from({length: k}, (_, i) => ({ x: potentialOffsets[i], y: potentialElevations[i] })).sort((a, b) => a.x - b.x);
                            found = true;
                            break;
                        }
                    }
                }
                if (!found && values.length % 2 === 0) {
                     const k = values.length / 2;
                     const elevations = values.slice(0, k);
                     const offsets = values.slice(k);
                     dataMap[mileage] = Array.from({length: k}, (_, i) => ({ x: offsets[i], y: elevations[i] })).sort((a, b) => a.x - b.x);
                } else if (!found) {
                     console.warn(`無法解析第 ${index + 1} 行資料: "${line}"。`);
                }
            });
            return dataMap;
        }
        
        function processData() {
            document.getElementById('error-message').textContent = '';
            try {
                if (!document.getElementById('section1Data').value.trim()) throw new Error("斷面 1 為必填欄位。");
                dataMap1 = parseData(document.getElementById('section1Data').value);
                dataMap2 = parseData(document.getElementById('section2Data').value);
                dataMap3 = parseData(document.getElementById('section3Data').value);

                const mileageSet = new Set([...Object.keys(dataMap1), ...Object.keys(dataMap2), ...Object.keys(dataMap3)]);
                allSortedMileages = Array.from(mileageSet).map(Number).sort((a, b) => b - a);
                if (allSortedMileages.length === 0) throw new Error("未解析出有效的里程資料。請檢查資料格式。");
                
                const selector = document.getElementById('mileageSelector');
                selector.innerHTML = '';
                allSortedMileages.forEach(mileage => selector.add(new Option(mileage, mileage)));
                document.querySelectorAll('#results-container > .data-card').forEach(card => card.classList.remove('hidden'));
                
                renderAnalysisSelectors();
                runAllAnalyses();

            } catch (error) {
                 document.getElementById('error-message').textContent = `錯誤: ${error.message}`;
                 document.querySelectorAll('#results-container > .data-card').forEach(card => card.classList.add('hidden'));
            }
        }
        
        function runAllAnalyses() {
            calculateAndDisplayOverallSummary();
            displayAllMileageCharts();
            updateIndividualDisplay();
        }

        function updateIndividualDisplay() {
            const selectedMileage = document.getElementById('mileageSelector').value;
            if (!selectedMileage) return;
            const p1 = dataMap1[selectedMileage] || [], p2 = dataMap2[selectedMileage] || [], p3 = dataMap3[selectedMileage] || [];
            createOrUpdateChart('mainChart', document.getElementById('elevationChart'), selectedMileage, p1, p2, p3);
            
            const dataMaps = { 1: p1, 2: p2, 3: p3 };
            const selectedP1 = dataMaps[analysisPair.a];
            const selectedP2 = dataMaps[analysisPair.b];

            calculateAndDisplayIndividualDifferences(p1, p2, p3);
            const areas = calculateSectionArea(selectedP1, selectedP2);
            document.getElementById('areaDisplay').innerHTML = `<span class="font-semibold text-red-600">挖方(Cut):</span> ${areas.cutArea.toFixed(3)} m² &nbsp;&nbsp; <span class="font-semibold text-green-600">填方(Fill):</span> ${areas.fillArea.toFixed(3)} m²`;
        }
        
        function createOrUpdateChart(chartId, canvasEl, mileage, p1, p2, p3) {
            if (charts[chartId]) charts[chartId].destroy();
            const datasets = [
                { label: document.getElementById('section1Name').value, data: p1, borderColor: 'rgb(59, 130, 246)', tension: 0.1, fill: false, pointRadius: 5 },
                { label: document.getElementById('section2Name').value, data: p2, borderColor: 'rgb(239, 68, 68)', tension: 0.1, fill: false, pointRadius: 5 }
            ];
            if (p3 && p3.length > 0) {
                datasets.push({ label: document.getElementById('section3Name').value, data: p3, borderColor: 'rgb(34, 197, 94)', tension: 0.1, fill: false, pointRadius: 5, borderDash: [5, 5] });
            }
            charts[chartId] = new Chart(canvasEl, { type: 'line', data: { datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: `里程 ${mileage} 斷面圖`, font: { size: 18 } } }, scales: { x: { type: 'linear', title: { display: true, text: '支距 (m)' } }, y: { title: { display: true, text: '高程 (m)' } } } } });
        }

        function displayAllMileageCharts() {
            const container = document.getElementById('allMileageChartsContainer');
            container.innerHTML = '';
            allSortedMileages.forEach(m => {
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'small-chart-container';
                const canvas = document.createElement('canvas');
                chartWrapper.appendChild(canvas);
                container.appendChild(chartWrapper);
                createOrUpdateChart(`mileage-${m}`, canvas, m, dataMap1[m] || [], dataMap2[m] || [], dataMap3[m] || []);
            });
        }

        function interpolate(points, x) {
            if (points.length < 2) return null;
            let p1 = null, p2 = null;
            for (let i = 0; i < points.length - 1; i++) if (points[i].x <= x && points[i+1].x >= x) { p1 = points[i]; p2 = points[i+1]; break; }
            if (!p1 || !p2) return null;
            if (p2.x === p1.x) return p1.y;
            return p1.y + (x - p1.x) * (p2.y - p1.y) / (p2.x - p1.x);
        }
        
        function findClosestPoint(points, x) {
            return points.length > 0 ? points.reduce((p, c) => (Math.abs(c.x - x) < Math.abs(p.x - x) ? c : p)) : null;
        }

        function calculateAndDisplayIndividualDifferences(p1, p2, p3) {
            const container = document.getElementById('differenceTableContainer');
            const isSection3Active = p3 && p3.length > 0;
            const sortedOffsets = [...new Set([...p1.map(p => p.x), ...p2.map(p => p.x), ...(isSection3Active ? p3.map(p => p.x) : [])])].sort((a, b) => a - b);
            const n1 = document.getElementById('section1Name').value, n2 = document.getElementById('section2Name').value, n3 = document.getElementById('section3Name').value;
            
            let tableHeader = `<thead class="bg-gray-50"><tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">支距(m)</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">${n1}(m)</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">${n2}(m)</th>
                ${isSection3Active ? `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">${n3}(m)</th>` : ''}
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">差(${document.getElementById(`section${analysisPair.a}Name`).value} - ${document.getElementById(`section${analysisPair.b}Name`).value})(cm)</th>
                </tr></thead>`;

            let tableBody = `<tbody class="bg-white divide-y divide-gray-200">`;
            for (const offset of sortedOffsets) {
                const y1 = interpolate(p1, offset), y2 = interpolate(p2, offset), y3 = isSection3Active ? interpolate(p3, offset) : null;
                const dataMaps = {1: y1, 2: y2, 3: y3};
                const val1 = dataMaps[analysisPair.a];
                const val2 = dataMaps[analysisPair.b];
                let diff = (val1 !== null && val2 !== null) ? ((val1 - val2) * 100).toFixed(1) : 'N/A';
                
                tableBody += `<tr>
                    <td class="px-4 py-4">${offset.toFixed(2)}</td>
                    <td class="px-4 py-4">${y1?.toFixed(3)??'N/A'}</td>
                    <td class="px-4 py-4">${y2?.toFixed(3)??'N/A'}</td>
                    ${isSection3Active ? `<td class="px-4 py-4">${y3?.toFixed(3)??'N/A'}</td>` : ''}
                    <td class="px-4 py-4 ${parseFloat(diff)>=0?'text-red-600':'text-green-600'}">${diff}</td>
                </tr>`;
            }
            tableBody += `</tbody>`;
            container.innerHTML = `<table class="min-w-full divide-y divide-gray-200">${tableHeader}${tableBody}</table>`;
        }
        
        function calculateSectionArea(p1, p2) {
            let cut = 0, fill = 0;
            const allOffsets = [...new Set([...p1.map(p => p.x), ...p2.map(p => p.x)])].sort((a, b) => a - b);
            for (let i = 0; i < allOffsets.length - 1; i++) {
                const x1 = allOffsets[i], x2 = allOffsets[i+1];
                const y1_s = interpolate(p1, x1), y2_s = interpolate(p2, x1), y1_e = interpolate(p1, x2), y2_e = interpolate(p2, x2);
                if (y1_s === null || y2_s === null || y1_e === null || y2_e === null) continue;
                const h1 = y1_s - y2_s, h2 = y1_e - y2_e, w = x2 - x1;
                if (h1 * h2 >= 0) { const a = (h1 + h2) / 2 * w; if (a > 0) cut += a; else fill -= a; } 
                else {
                    const m1 = (y1_e - y1_s) / w, m2 = (y2_e - y2_s) / w;
                    if (m1 === m2) continue;
                    const iX = x1 + (y2_s - y1_s) / (m1 - m2);
                    const a1 = 0.5 * h1 * (iX - x1); if (a1 > 0) cut += a1; else fill -= a1;
                    const a2 = 0.5 * h2 * (x2 - iX); if (a2 > 0) cut += a2; else fill -= a2;
                }
            }
            return { cutArea: cut, fillArea: fill };
        }

        function calculateAndDisplayOverallSummary() {
            let totalCut = 0, totalFill = 0;
            const dataMaps = { 1: dataMap1, 2: dataMap2, 3: dataMap3 };
            const selectedMap1 = dataMaps[analysisPair.a];
            const selectedMap2 = dataMaps[analysisPair.b];

            const areas = allSortedMileages.map(m => ({ mileage: parseFloat(m), ...calculateSectionArea(selectedMap1[m]||[], selectedMap2[m]||[]) }));
            for (let i = 0; i < areas.length - 1; i++) {
                const s1 = areas[i], s2 = areas[i+1], dist = Math.abs(s1.mileage - s2.mileage);
                totalCut += ((s1.cutArea + s2.cutArea) / 2) * dist;
                totalFill += ((s1.fillArea + s2.fillArea) / 2) * dist;
            }
            
            const n1 = document.getElementById(`section${analysisPair.a}Name`).value;
            const n2 = document.getElementById(`section${analysisPair.b}Name`).value;
            const titleText = `(${n1} vs ${n2})`;

            document.getElementById('volume-title').textContent = `總土方量 ${titleText}`;
            document.getElementById('area-table-title').textContent = `各斷面積列表 ${titleText}`;
            document.getElementById('area-title').textContent = `斷面面積 ${titleText}`;

            document.getElementById('totalVolumeDisplay').innerHTML = `<span class="font-semibold text-red-600">總挖方量:</span> ${totalCut.toFixed(3)} m³ &nbsp;&nbsp; <span class="font-semibold text-green-600">總填方量:</span> ${totalFill.toFixed(3)} m³`;
            const areaContainer = document.getElementById('areaTableContainer');
            let table = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs text-gray-500 uppercase">里程</th><th class="px-6 py-3 text-left text-xs text-gray-500 uppercase">挖方(m²)</th><th class="px-6 py-3 text-left text-xs text-gray-500 uppercase">填方(m²)</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            areas.forEach(a => { table += `<tr><td class="px-6 py-4 font-semibold">${a.mileage}</td><td class="px-6 py-4 text-red-600">${a.cutArea.toFixed(3)}</td><td class="px-6 py-4 text-green-600">${a.fillArea.toFixed(3)}</td></tr>`; });
            areaContainer.innerHTML = table + '</tbody></table>';
        }

        function generateSummaryReport() {
            const offsetsInput = document.getElementById('customOffsets').value;
            if (!offsetsInput.trim()) { alert('請輸入指定支距。'); return; }
            const customOffsets = offsetsInput.trim().split(/[\s,]+/).map(Number).filter(n => !isNaN(n)).sort((a,b) => a-b);
            if (customOffsets.length === 0) { alert('指定支距格式無效。'); return; }
            
            const dataMaps = { 1: dataMap1, 2: dataMap2, 3: dataMap3 };
            const selectedMap1 = dataMaps[analysisPair.a];
            const selectedMap2 = dataMaps[analysisPair.b];
            
            const container = document.getElementById('summaryTableContainer');
            let table = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs text-gray-500 uppercase">里程</th>`;
            customOffsets.forEach(o => { table += `<th class="px-6 py-3 text-left text-xs text-gray-500 uppercase">支距 ${o.toFixed(2)}(cm)</th>`; });
            table += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            allSortedMileages.forEach(m => {
                table += `<tr><td class="px-6 py-4 font-semibold">${m}</td>`;
                const p1 = selectedMap1[m]||[], p2 = selectedMap2[m]||[];
                customOffsets.forEach(o => {
                    let y1 = interpolate(p1, o), y2 = interpolate(p2, o), note = '', nO = null;
                    if (y1 === null && p1.length > 0) { const c = findClosestPoint(p1, o); y1 = c.y; nO = c.x; }
                    if (y2 === null && p2.length > 0) { const c = findClosestPoint(p2, o); y2 = c.y; nO = nO || c.x; }
                    if (nO !== null) note = `<span class="text-xs text-gray-400 ml-1">(近${nO.toFixed(2)})</span>`;
                    const diff = (y1 !== null && y2 !== null) ? ((y1 - y2) * 100).toFixed(1) : 'N/A';
                    table += `<td class="px-6 py-4 ${parseFloat(diff)>=0?'text-red-600':'text-green-600'}">${diff==='N/A'?'N/A':diff+note}</td>`;
                });
                table += `</tr>`;
            });
            container.innerHTML = table + '</tbody></table>';
        }

        function generateShareData() {
            return {
                n1: document.getElementById('section1Name').value, n2: document.getElementById('section2Name').value, n3: document.getElementById('section3Name').value,
                d1: document.getElementById('section1Data').value, d2: document.getElementById('section2Data').value, d3: document.getElementById('section3Data').value,
                c: document.getElementById('customOffsets').value,
                ap: analysisPair
            };
        }

        function generateShareLink() {
            try {
                const data = generateShareData();
                const jsonString = JSON.stringify(data);
                const compressed = pako.deflate(jsonString, { to: 'string' });
                const base64 = btoa(compressed);
                const shareUrl = `${window.location.href.split('?')[0]}?data=${encodeURIComponent(base64)}`;
                const modalContent = document.getElementById('shareModalContent');

                if (shareUrl.length > URL_LENGTH_LIMIT) {
                    modalContent.innerHTML = `
                        <h3 class="text-xl font-semibold mb-4 text-orange-600">連結過長警告</h3>
                        <p class="text-gray-600 mb-4">您的資料量過大，產生的分享連結可能無法正常運作。建議改用檔案分享，更為穩定。</p>
                        <div class="flex justify-end space-x-3">
                            <button id="downloadButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">下載資料檔</button>
                            <button id="closeModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">關閉</button>
                        </div>`;
                    document.getElementById('downloadButton').onclick = downloadDataFile;
                } else {
                     modalContent.innerHTML = `
                        <h3 class="text-xl font-semibold mb-4">分享您的分析結果</h3>
                        <p class="text-gray-600 mb-2">複製下方的連結，任何人開啟後都能看到您目前的資料與分析結果。</p>
                        <input type="text" id="shareLinkInput" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 mb-4" value="${shareUrl}" readonly>
                        <div class="flex justify-end space-x-3">
                            <button id="copyLinkButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">複製連結</button>
                            <button id="closeModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">關閉</button>
                        </div>`;
                    document.getElementById('copyLinkButton').onclick = copyShareLink;
                }
                document.getElementById('closeModalButton').onclick = closeShareModal;
                openShareModal();
            } catch (e) {
                document.getElementById('error-message').textContent = '生成分享內容失敗: ' + e.message;
            }
        }
        
        function downloadDataFile() {
            const data = generateShareData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'analysis_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            closeShareModal();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.n1) document.getElementById('section1Name').value = data.n1;
                    if (data.n2) document.getElementById('section2Name').value = data.n2;
                    if (data.n3) document.getElementById('section3Name').value = data.n3;
                    if (data.d1) document.getElementById('section1Data').value = data.d1;
                    if (data.d2) document.getElementById('section2Data').value = data.d2;
                    if (data.d3) document.getElementById('section3Data').value = data.d3;
                    if (data.c) document.getElementById('customOffsets').value = data.c;
                    if (data.ap) analysisPair = data.ap;
                    document.getElementById('processButton').click();
                    if (data.c) setTimeout(() => document.getElementById('summaryButton').click(), 100);
                } catch (err) {
                    alert('檔案格式錯誤或內容已損毀。');
                }
            };
            reader.readAsText(file);
        }

        function loadDataFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            if (dataParam) {
                try {
                    const jsonString = pako.inflate(atob(decodeURIComponent(dataParam)), { to: 'string' });
                    const data = JSON.parse(jsonString);
                    if (data.n1) document.getElementById('section1Name').value = data.n1;
                    if (data.n2) document.getElementById('section2Name').value = data.n2;
                    if (data.n3) document.getElementById('section3Name').value = data.n3;
                    if (data.d1) document.getElementById('section1Data').value = data.d1;
                    if (data.d2) document.getElementById('section2Data').value = data.d2;
                    if (data.d3) document.getElementById('section3Data').value = data.d3;
                    if (data.c) document.getElementById('customOffsets').value = data.c;
                    if (data.ap) analysisPair = data.ap;
                    document.getElementById('processButton').click();
                    if (data.c) setTimeout(() => document.getElementById('summaryButton').click(), 100);
                } catch (e) {
                    document.getElementById('error-message').textContent = '讀取分享資料失敗。';
                    loadDefaultData();
                }
            } else {
                 loadDefaultData();
            }
        }
        
        function openShareModal() {
            const modal = document.getElementById('shareModal');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
        }

        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function copyShareLink() {
            const input = document.getElementById('shareLinkInput');
            input.select();
            navigator.clipboard.writeText(input.value).then(() => alert('連結已複製到剪貼簿！'))
            .catch(() => alert('複製失敗，請手動複製。'));
        }
        
        function setupCollapsibleSections() {
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('.chevron-icon');
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                });
            });
        }
        
        function renderAnalysisSelectors() {
            const n1 = document.getElementById('section1Name').value;
            const n2 = document.getElementById('section2Name').value;
            const n3 = document.getElementById('section3Name').value;
            const hasS3 = document.getElementById('section3Data').value.trim() !== '';

            let selectorHTML = `<div class="flex flex-wrap gap-4 justify-center">`;
            selectorHTML += `
                <div>
                    <input type="radio" name="analysisPair" id="pair12" value="1-2" class="hidden" ${analysisPair.a === 1 && analysisPair.b === 2 ? 'checked' : ''}>
                    <label for="pair12" class="radio-label">${n1} vs ${n2}</label>
                </div>`;
            if (hasS3) {
                 selectorHTML += `
                <div>
                    <input type="radio" name="analysisPair" id="pair13" value="1-3" class="hidden" ${analysisPair.a === 1 && analysisPair.b === 3 ? 'checked' : ''}>
                    <label for="pair13" class="radio-label">${n1} vs ${n3}</label>
                </div>
                <div>
                    <input type="radio" name="analysisPair" id="pair23" value="2-3" class="hidden" ${analysisPair.a === 2 && analysisPair.b === 3 ? 'checked' : ''}>
                    <label for="pair23" class="radio-label">${n2} vs ${n3}</label>
                </div>`;
            }
            selectorHTML += `</div>`;
            
            document.getElementById('analysis-selector-1').innerHTML = selectorHTML;
            document.getElementById('analysis-selector-2').innerHTML = selectorHTML;

            document.querySelectorAll('input[name="analysisPair"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const [a, b] = e.target.value.split('-').map(Number);
                    analysisPair = { a, b };
                    runAllAnalyses();
                });
            });
        }

        function loadDefaultData() {
            document.getElementById('section1Name').value = '原地面';
            document.getElementById('section2Name').value = '刨除後';
            document.getElementById('section3Name').value = '舖築後';
            document.getElementById('section1Data').value = `0			19.813	19.950	20.000	19.985	19.955				-5.1	-2.55	0	2.45	5.1	
10			18.748	18.813	18.853	18.807	18.780				-5.04	-2.52	0	2.48	5.04	
20			17.791	17.859	17.914	17.904	17.879				-5.02	-2.51	0	2.49	5.02	
30			16.969	17.084	17.149	17.154	17.149				-5.01	-2.505	0	2.495	5.01	
40			16.362	16.451	16.499	16.493	16.466				-5	-2.5	0	2.5	5	
50			15.806	15.921	15.986	15.978	15.946				-5.02	-2.51	0	2.49	5.02	
60			15.297	15.387	15.442	15.442	15.427				-5	-2.5	0	2.5	5	
70		14.804	14.882	14.835	14.877	14.897	14.892			-4.95	-2.98	-2.93	0	3.6	4.95	
80		14.310	14.345	14.300	14.348	14.415	14.415	14.418		-4.95	-3.02	-2.98	0	3.47	3.55	4.95
90		13.825	13.865	13.810	13.860	13.900	13.942	13.950		-4.95	-3	-2.95	0	3.5	3.55	4.95
100		13.363	13.388	13.358	13.393	13.403	13.453	13.456		-4.95	-3	-2.95	0	3.29	3.35	4.95
110		12.863	12.923	12.878	12.938	12.918	12.978	12.967		-4.9	-3.1	-3.06	0	3.32	3.39	4.9
120		12.375	12.463	12.416	12.503	12.518	12.578	12.548		-4.85	-3.15	-3.09	0	3.24	3.31	4.85
130		11.893	11.958	11.918	11.978	12.018	12.058	12.088		-4.9	-3.27	-3.22	0	3.09	3.16	4.9
140		11.408	11.429	11.392	11.437	11.420	11.462	11.437		-4.75	-3.28	-3.23	0	3.12	3.21	4.75
150		10.697	10.762	10.723	10.807	10.782	10.827	10.764		-4.77	-3.23	-3.15	0	3.19	3.25	4.77
160		10.132	10.187	10.147	10.187	10.169	10.205	10.167		-4.89	-3.19	-3.09	0	3.28	3.33	4.89
170		9.578	9.608	9.579	9.602	9.572	9.622	9.571		-4.84	-3.52	-3.49	0	3.9	3.36	4.84
180		8.987	9.032	8.992	9.047	9.012	9.052	9.002		-4.85	-3.52	-3.48	0	3.27	3.35	4.85
190		8.579	8.542	8.504	8.504	8.474	8.521	8.507		-4.82	-3.44	-3.41	0	3.3	3.38	4.82
200		8.174	8.194	8.137	8.164	8.161	8.204	8.234		-4.8	-3.5	-3.47	0	3.29	3.33	4.8
210	7.837	7.919	8.019	8.054	8.059	7.984	7.971		-4.12	-3.26	-3.22	-0.97	0	4.08	4.12	
220	7.814	7.739	7.841	7.874	7.869	7.804	7.819		-4	-3.27	-3.22	-0.82	0	3.98	4	
230	7.639	7.564	7.664	7.694	7.699	7.639	7.669		-4.02	-3.3	-3.26	-0.84	0	3.99	4.02	
240	7.446	7.357	7.461	7.514	7.519	7.464	7.469		-4.04	-3.33	-3.29	-0.86	0	4.02	4.04	
250	7.356	7.268	7.366	7.402	7.411	7.411	7.416		-4.04	-3.33	-3.29	-0.87	0	4.02	4.04	
260	7.271	7.201	7.301	7.346	7.359	7.346	7.346		-4.04	-3.33	-3.28	-0.84	0	4.02	4.04	
270	7.218	7.136	7.236	7.293	7.296	7.276	7.266		-4.07	-3.37	-3.34	-0.87	0	4.05	4.07	
280	7.131	7.051	7.151	7.201	7.211	7.176	7.171		-4.13	-3.41	-3.37	-0.9	0	4.11	4.13	
290	6.963	6.882	6.956	6.981	6.981	6.973	6.966		-4.2	-3.48	-3.44	-0.89	0	4.14	4.2	
300	6.768	6.686	6.786	6.822	6.827	6.770	6.762		-4.12	-3.38	-3.34	-0.84	0	4.1	4.12	
310	6.597	6.513	6.617	6.659	6.654	6.632	6.622		-4.13	-3.37	-3.33	-0.83	0	4.11	4.13	
320	6.440	6.357	6.457	6.517	6.522	6.462	6.452		-4.14	-3.37	-3.33	-0.82	0	4.1	4.14	
330	6.310	6.227	6.332	6.384	6.382	6.322	6.332		-4.14	-3.43	-3.36	-0.77	0	4.16	4.19	
340	6.292	6.206	6.308	6.340	6.340	6.362	6.362		-4.2	-3.4	-3.36	-0.77	0	4.17	4.2	
350	6.258	6.182	6.282	6.322	6.322	6.277	6.268		-4.185	-3.425	-3.385	-0.745	0	4.155	4.185	
360	6.192	6.085	6.179	6.212	6.215	6.202	6.225		-4.22	-3.45	-3.41	-0.72	0	4.18	4.22	
370	6.117	6.052	6.142	6.157	6.159	6.155	6.149		-4.23	-3.4	-3.36	-0.7	0	4.2	4.23	
380	6.033	5.958	6.050	6.063	6.058	6.043	6.033		-4.24	-3.43	-3.38	-0.71	0	4.19	4.24	
390	5.953	5.891	5.990	5.998	5.998	5.918	5.898		-4.23	-3.41	-3.37	-0.73	0	4.17	4.23	
400	5.801	5.733	5.820	5.851	5.825	5.788	5.768		-4.21	-3.41	-3.36	-0.79	0	4.18	4.21	
410	5.625	5.583	5.660	5.697	5.678	5.655	5.648		-4.215	-3.415	-3.365	-0.795	0	4.185	4.215	
420	5.427	5.359	5.457	5.512	5.512	5.462	5.444		-4.2	-3.43	-3.38	-0.78	0	4.16	4.2	
430	5.317	5.242	5.342	5.392	5.404	5.337	5.312		-4.16	-3.36	-3.33	-0.75	0	4.12	4.16	
440	5.222	5.162	5.262	5.307	5.312	5.265	5.267		-4.15	-3.32	-3.29	-0.77	0	4.13	4.15	
450	5.052	4.977	5.077	5.132	5.149	5.152	5.136		-4.15	-3.31	-3.25	-0.79	0	4.11	4.15	
460	5.005	4.922	5.022	5.052	5.057	5.052	5.024		-4.15	-3.34	-3.3	-0.8	0	4.1	4.15	
470	4.742	4.837	4.937	4.977	4.982	4.957	4.940		-4.13	-3.37	-3.33	-0.79	0	4.09	4.13	
480	4.768	4.682	4.782	4.827	4.842	4.829	4.812		-4.15	-3.35	-3.35	-0.81	0	4.09	4.15	
490		4.668	4.594	4.644	4.644	4.591	4.586				-5.13	-2.23	0	0.17	5.11	5.13`;
            document.getElementById('section2Data').value = `0	19.813	20.010	19.895	-5.100	0.000	5.100
10	18.759	18.883	18.748	-5.040	0.000	5.040
20	17.802	17.944	17.847	-5.020	0.000	5.020
30	16.980	17.179	17.117	-5.010	0.000	5.010
40	16.373	16.529	16.434	-5.000	0.000	5.000
50	15.817	15.999	15.909	-5.020	0.000	5.020
60	15.308	15.458	15.384	-5.000	0.000	5.000
70	14.814	14.907	14.860	-4.950	0.000	4.950
80	14.321	14.378	14.378	-4.950	0.000	4.950
90	13.832	13.890	13.897	-4.950	0.000	4.950
100	13.363	13.411	13.416	-4.950	0.000	4.950
110	12.863	12.922	12.935	-4.900	0.000	4.900
120	12.375	12.473	12.488	-4.850	0.000	4.850
130	11.893	11.948	12.028	-4.900	0.000	4.900
140	11.388	11.407	11.377	-4.750	0.000	4.750
150	10.708	10.792	10.732	-4.770	0.000	4.770
160	10.138	10.217	10.135	-4.890	0.000	4.890
170	9.578	9.632	9.539	-4.840	0.000	4.840
180	8.998	9.077	8.970	-4.850	0.000	4.850
190	8.559	8.554	8.475	-4.820	0.000	4.820
200	8.174	8.194	8.182	-4.800	0.000	4.800
210	7.767	8.043	7.939	-4.120	0.000	4.120
220	7.744	7.882	7.771	-4.000	0.000	4.000
230	7.574	7.721	7.609	-4.020	0.000	4.020
240	7.415	7.549	7.437	-4.040	0.000	4.040
250	7.324	7.441	7.356	-4.040	0.000	4.040
260	7.233	7.348	7.286	-4.040	0.000	4.040
270	7.148	7.245	7.206	-4.070	0.000	4.070
280	7.061	7.141	7.111	-4.130	0.000	4.130
290	6.893	6.992	6.914	-4.200	0.000	4.200
300	6.728	6.843	6.730	-4.120	0.000	4.120
310	6.566	6.684	6.575	-4.130	0.000	4.130
320	6.409	6.552	6.420	-4.140	0.000	4.140
330	6.279	6.412	6.300	-4.140	0.000	4.190
340	6.228	6.340	6.302	-4.200	0.000	4.200
350	6.188	6.258	6.221	-4.185	0.000	4.185
360	6.122	6.175	6.165	-4.220	0.000	4.220
370	6.047	6.093	6.089	-4.230	0.000	4.230
380	5.963	6.011	5.973	-4.240	0.000	4.240
390	5.883	5.928	5.838	-4.230	0.000	4.230
400	5.731	5.801	5.708	-4.210	0.000	4.210
410	5.558	5.674	5.588	-4.215	0.000	4.215
420	5.396	5.542	5.412	-4.200	0.000	4.200
430	5.271	5.420	5.280	-4.160	0.000	4.160
440	5.152	5.293	5.207	-4.150	0.000	4.150
450	5.021	5.166	5.086	-4.150	0.000	4.150
460	4.935	5.039	4.977	-4.150	0.000	4.150
470	4.711	4.912	4.880	-4.130	0.000	4.130
480	4.698	4.783	4.752	-4.150	0.000	4.150
490	4.598	4.654	4.526	-5.130	0.000	5.130`;
            document.getElementById('section3Data').value = `0	19.883	20.08	19.965	-5.100	0.000	5.100
10	18.829	18.953	18.818	-5.040	0.000	5.040
20	17.872	18.014	17.917	-5.020	0.000	5.020
30	17.05	17.249	17.187	-5.010	0.000	5.010
40	16.443	16.599	16.504	-5.000	0.000	5.000
50	15.887	16.069	15.979	-5.020	0.000	5.020
60	15.378	15.528	15.454	-5.000	0.000	5.000
70	14.884	14.977	14.93	-4.950	0.000	4.950
80	14.391	14.448	14.448	-4.950	0.000	4.950
90	13.902	13.96	13.967	-4.950	0.000	4.950
100	13.433	13.481	13.486	-4.950	0.000	4.950
110	12.933	12.992	13.005	-4.900	0.000	4.900
120	12.445	12.543	12.558	-4.850	0.000	4.850
130	11.963	12.018	12.098	-4.900	0.000	4.900
140	11.458	11.477	11.447	-4.750	0.000	4.750
150	10.778	10.862	10.802	-4.770	0.000	4.770
160	10.208	10.287	10.205	-4.890	0.000	4.890
170	9.648	9.702	9.609	-4.840	0.000	4.840
180	9.068	9.147	9.04	-4.850	0.000	4.850
190	8.629	8.624	8.545	-4.820	0.000	4.820
200	8.244	8.264	8.252	-4.800	0.000	4.800
210	7.837	8.113	8.009	-4.120	0.000	4.120
220	7.814	7.952	7.841	-4.000	0.000	4.000
230	7.644	7.791	7.679	-4.020	0.000	4.020
240	7.485	7.619	7.507	-4.040	0.000	4.040
250	7.394	7.511	7.426	-4.040	0.000	4.040
260	7.303	7.418	7.356	-4.040	0.000	4.040
270	7.218	7.315	7.276	-4.070	0.000	4.070
280	7.131	7.211	7.181	-4.130	0.000	4.130
290	6.963	7.062	6.984	-4.200	0.000	4.200
300	6.798	6.913	6.8	-4.120	0.000	4.120
310	6.636	6.754	6.645	-4.130	0.000	4.130
320	6.479	6.622	6.49	-4.140	0.000	4.140
330	6.349	6.482	6.37	-4.140	0.000	4.190
340	6.298	6.41	6.372	-4.200	0.000	4.200
350	6.258	6.328	6.291	-4.185	0.000	4.185
360	6.192	6.245	6.235	-4.220	0.000	4.220
370	6.117	6.163	6.159	-4.230	0.000	4.230
380	6.033	6.081	6.043	-4.240	0.000	4.240
390	5.953	5.998	5.908	-4.230	0.000	4.230
400	5.801	5.871	5.778	-4.210	0.000	4.210
410	5.628	5.744	5.658	-4.215	0.000	4.215
420	5.466	5.612	5.482	-4.200	0.000	4.200
430	5.341	5.49	5.35	-4.160	0.000	4.160
440	5.222	5.363	5.277	-4.150	0.000	4.150
450	5.091	5.236	5.156	-4.150	0.000	4.150
460	5.005	5.109	5.047	-4.150	0.000	4.150
470	4.781	4.982	4.95	-4.130	0.000	4.130
480	4.768	4.853	4.822	-4.150	0.000	4.150
490	4.668	4.724	4.596	-5.130	0.000	5.130`;
            document.getElementById('customOffsets').value = "-4.2 -2.8 -1.4 0 1.4 2.8 4.2";
        }
        
        // --- 啟動程序 ---
        window.onload = loadDataFromUrl;
        document.getElementById('processButton').addEventListener('click', processData);
        document.getElementById('mileageSelector').addEventListener('change', updateIndividualDisplay);
        document.getElementById('summaryButton').addEventListener('click', generateSummaryReport);
        document.getElementById('shareButton').addEventListener('click', generateShareLink);
        document.getElementById('importButton').addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('fileInput').addEventListener('change', handleFileImport);
        setupCollapsibleSections();
    </script>
</body>
</html>
